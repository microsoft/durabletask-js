name: ğŸ§ª DTS Emulator E2E Tests

# This workflow runs E2E tests against the Durable Task Scheduler (DTS) emulator.
# Tests are split across parallel jobs with separate task hubs for isolation.

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  dts-e2e-tests:
    strategy:
      fail-fast: false
      matrix:
        node-version: ["22.x", "24.x"]
        test-group:
          - name: "entity"
            pattern: "test/e2e-azuremanaged/entity.spec.ts"
          - name: "orchestration"
            pattern: "test/e2e-azuremanaged/orchestration.spec.ts"
          - name: "query-restart"
            pattern: "test/e2e-azuremanaged/query-apis.spec.ts test/e2e-azuremanaged/restart.spec.ts"
          - name: "retry-history-rewind"
            pattern: "test/e2e-azuremanaged/retry-handler.spec.ts test/e2e-azuremanaged/retry-advanced.spec.ts test/e2e-azuremanaged/history.spec.ts test/e2e-azuremanaged/rewind.spec.ts"
    name: "e2e (${{ matrix.test-group.name }}, node ${{ matrix.node-version }})"
    env:
      EMULATOR_VERSION: "latest"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Pull Docker image
        run: docker pull mcr.microsoft.com/dts/dts-emulator:$EMULATOR_VERSION

      - name: ğŸš€ Run Docker container
        run: |
          docker run --name dtsemulator -d -p 8080:8080 mcr.microsoft.com/dts/dts-emulator:$EMULATOR_VERSION

      - name: â³ Wait for container to be ready
        run: sleep 10

      - name: ğŸ”§ Set environment variables
        run: |
          echo "TASKHUB=${{ matrix.test-group.name }}" >> $GITHUB_ENV
          echo "ENDPOINT=localhost:8080" >> $GITHUB_ENV

      - name: âš™ï¸ NodeJS - Install
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: "https://registry.npmjs.org"

      - name: âš™ï¸ Install dependencies
        run: npm ci

      - name: âœ… Run E2E tests â€” ${{ matrix.test-group.name }}
        run: npx jest ${{ matrix.test-group.pattern }} --runInBand --detectOpenHandles
        timeout-minutes: 15
